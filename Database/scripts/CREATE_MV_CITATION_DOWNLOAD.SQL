DROP MATERIALIZED VIEW MV_CITATION_DOWNLOAD;

CREATE MATERIALIZED VIEW CADDIS_DEV.MV_CITATION_DOWNLOAD 
TABLESPACE CADDIS_DATA
PCTUSED    0
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
NOCACHE
LOGGING
NOCOMPRESS
NOPARALLEL
BUILD IMMEDIATE
REFRESH FORCE ON DEMAND
WITH PRIMARY KEY
AS 
SELECT DISTINCT C.CITATION_ID
            ,  D.DATASET_ID
            , C.AUTHOR
            , GET_ITEM_CODE( C.LL_PUBLICATION_ID) AS CIT_PUB_CODE
            , C.TITLE
            , C.VOLUME
            , C.YEAR
            , V_S_C.LIST_ITEM_CODE SOURCE_CLASS_CODE
            , V_S.LIST_ITEM_CODE SOURCE_OF_STRESS_CODE
            , V_S_G.LIST_ITEM_CODE SOURCE_GROUP_CODE
            ,  GET_ITEM_CODE(D.LL_STUDY_TYPE_ID) AS STUDY_TYPE_CODE
            ,  GET_ITEM_CODE(D.LL_DESIGN_TYPE_ID) AS DESIGN_TYPE_CODE
            ,  GET_ITEM_CODE(D.LL_HABITAT_ID) AS HABITAT_CODE
            ,  D.NUM_SAMPLING_UNITS
            ,  D. NUM_REPS_SU
            ,  D.SAMPLING_UNIT_TYPE
            ,  D.SEASON
            , D.DURATION
            ,  GET_ITEM_CODE(D.LL_DURATION_UNITS) AS DATASET_DURATION_UNIT_CODE
            , DECODE( EPA.IS_STRESSOR, 1, 'YES', 'NO') AS EXPOS_IS_STRESSOR
            , EPA.MEASUREMENT_METHOD AS EXPOS_MEAS_METHOD
            , GET_ITEM_CODE(EPA.LL_PARAMETER_MEASURED_ID) AS EXPOS_PARAM_MEAS_CODE
             , GET_ITEM_CODE(V_P.LL_PARA_CLASS_ID) AS EXPOS_PARAM_CLASS_CODE
             , GET_ITEM_CODE( V_P.LL_PARA_GROUP_ID) AS EXPOS_PARAM_GROUP_CODE
            , GET_ITEM_CODE( EPA.LL_MEDIA_ID) AS EXPOS_MEDIA_CODE
            , EPA.SAMPLE_SIZE_STATISTIC
            , EPA.MEASUREMENT_FREQUENCY
            ,  GET_ITEM_CODE(EPA.LL_PARAMETER_UNIT_ID) AS EXPOS_PARAM_UNIT_CODE
            , GET_ITEM_CODE( EPA.LL_MEASUREMENT_TYPE_ID) AS EXPOS_MEAS_TYPE_CODE
            ,  GET_ITEM_CODE(EPA.LL_MEASUREMENT_LOC_ID) AS EXPOS_MEAS_LOC_CODE
            , GET_ITEM_CODE(EPA.LL_MEASUREMENT_TIME_ID) AS EXPOS_MEAS_TIME_CODE
            , GET_ITEM_CODE(EPA.LL_MEASUREMENT_FREQUENCY_UNIT) AS EXPOS_MEAS_FREQ_UNIT_CODE
            
           , RS.METHOD AS RESPONSE_METHOD
           , RM.MEASUREMENT_METHOD AS RESPONSE_MEAS_METHOD
           , GET_ITEM_CODE( RM.RESPONSE_PARAM_ID ) AS RESPONSE_PARAM_CODE
           ,  GET_ITEM_CODE(V_PR.LL_PARA_CLASS_ID ) AS RESPONSE_PARAM_CLASS2_CODE
           , GET_ITEM_CODE( V_PR.LL_PARA_GROUP_ID) AS RESPONSE_PARAM_GRP2_CODE
           , RM.LL_SIGNIFICANCE_CODE AS RESP_SITE_CODE
           , GET_ITEM_CODE( RM.LL_LIFESTAGE_ID) AS RESPONSE_LIFESTAGE_CODE
           
           , TA.COMMON_NAME
           , TA.FFG_EDAS
           , TA.FFG_1
           , TA.FFG_2
           , TA.FFG_REFERENCE
           , TA.HABIT_EDAS
           , TA.HABIT_1
           , TA.HABIT_2
           , TA.HABIT_REFERENCE
           , TA.NATIVE
           , TA.STRATUM
           , TA.TROPHIC
           , TA.LITHOPHIL
           , TA.GUILD
           , TA.TOP_CARNIVORE_AND_TROUT
           , TA.RESIDENT_AND_TROUT
           , TA.COLD_WARMWATER
           , TA.MINNOWS
           , TA.FINAL_ID
           , TA.FINAL_TYPE
           ,  GET_ITEM_CODE(TA.LL_ASSEMBLAGE) AS TAX_ASSEMBLAGE_CODE
           ,  GET_ITEM_CODE(TA.LL_KINGDOM) AS TAX_KINGDOM_CODE
           ,  GET_ITEM_CODE(TA.LL_PHYLUM ) AS TAX_PHYLUM_CODE
           ,  GET_ITEM_CODE(TA.LL_CLASS) AS TAX_CLASS_CODE
           ,  GET_ITEM_CODE(TA.LL_ORDER) AS TAX_ORDER_CODE
           ,  GET_ITEM_CODE(TA.LL_FAMILY) AS TAX_FAMILY_CODE
           ,  GET_ITEM_CODE(TA.LL_TRIBE) AS TAX_TRIBE_CODE
           ,  GET_ITEM_CODE(TA.LL_GENUS) AS TAX_GENUS_CODE
           , GET_ITEM_CODE( TA.LL_SPECIES) AS TAX_SPECIES_CODE
           ,  GET_ITEM_CODE(TA.LL_VARIETY) AS TAX_VARIETY_CODE
FROM P_CITATION C
        , P_DATASET D
        , P_SOURCES S
        , V_SOURCE_OF_STRESSOR V_S
        , V_SOURCE_OF_STRESSOR_CLASS V_S_C
        , V_SOURCE_OF_STRESSOR_SOURCE_G V_S_G
        , P_EXPOSURE_SET ES
        , P_EXPOSURE_PARAMETERS EPA
        , P_RESPONSE_SET  RS
        , V_PARAMETER_STRESSOR V_P
      , P_EXPOSURE_RESPONSE_ASSOC ERA
      , P_RESPONSE_MEASURED RM
      , V_PARAMETER_RESPONSE V_PR
  --      , P_CLASS_DESCRIPTOR CD
   ,  P_LIST_ITEM_TAXA TA
WHERE C.CITATION_ID = D.CITATION_ID(+)
     AND D.DATASET_ID = S.DATASET_ID(+)
     AND S.LL_DESCRIPTOR_ID = V_S.LL_ID(+)
     AND V_S.LL_ID_PARENT = V_S_G.LL_ID(+)
     AND V_S_G.LL_ID_PARENT = V_S_C.LL_ID(+)
     AND D.DATASET_ID = ES.DATASET_ID(+)
     AND D.DATASET_ID = RS.DATASET_ID(+)
     AND ES.EXPOSURE_SET_ID = EPA.EXPOSURE_SET_ID(+)
     AND EPA.LL_PARAMETER_MEASURED_ID = V_P.LL_ID(+)
     AND ES.EXPOSURE_SET_ID = ERA.EXPOSURE_SET_ID
  --   AND RS.RESPONSE_SET_ID = ERA.RESPONSE_SET_ID
    AND RM.RESPONSE_PARAM_ID = V_PR.LL_ID(+)
    AND RS.RESPONSE_SET_ID = RM.RESPONSE_SET_ID(+)
    AND RM.TAXA_ID = TA.TAXA_ID
    ;
    
    
COMMENT ON MATERIALIZED VIEW CADDIS_DEV.MV_CITATION_DOWNLOAD IS 'snapshot table for snapshot CADDIS_DEV.MV_CITATION_DOWNLOAD';